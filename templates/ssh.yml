.ssh:exec:
  image: registry.jobtome.io/devops/docker-images/gcloud-sdk:v1.0.4
  stage: deploy
  script:
    - |
      # CHECK VARIABLES PHASE
      for var in "SSH_PRIVATE_KEY" "SSH_USER" "SSH_HOST" "SSH_COMMAND"; do
          if [ -z "${!var}" ]; then
            echo "Missing '${var}' variable!"
            exit 1
          fi
      done

      # CONNECTION PHASE
      apk update && apk add openssh-client
      echo "$SSH_PRIVATE_KEY" > gitlab-deploy && chmod 400 gitlab-deploy

      # DEPLOY PHASE
      echo
      echo "-> Executing command through ssh!"
      echo

      COMMAND_TO_RUN=( ssh -i gitlab-deploy -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null "${SSH_USER}@${SSH_HOST}" "${SSH_COMMAND}")

      ${COMMAND_TO_RUN[@]}

      echo
      echo "-> Command executed on ${SSH_HOST}!"
      echo
  variables:
    GIT_DEPTH: 1
  environment:
    name: ${ENVIRONMENT}
    url: https://${DOMAIN}
