notify_sentry:
  image: gdiener/ci-image-gcp:v1.0.1
  stage: notify
  script:
    - |
      if [ -z "${SENTRY_API_URL}" ]; then
        echo
        echo "-> [WARNING] Missing 'SENTRY_API_URL' variable!"
        echo
        exit 1
      fi

      if [ -z "${CI_COMMIT_TAG}" ]; then
        CI_COMMIT_TAG=${CI_COMMIT_SHA}
      fi

      PAYLOAD="{ \"version\": \"${CI_COMMIT_TAG}\" }"

      STATUS_CODE=$(curl -sS -o /tmp/response.txt --write-out "%{http_code}" -H 'Content-Type: application/json' -X POST -d "${PAYLOAD}" "${SENTRY_API_URL}")

      if [[ "${STATUS_CODE}" -ne 201 ]] ; then
        echo "Sentry webhook returned '${STATUS_CODE}' error!"
        echo
        echo "Response:"
        cat /tmp/response.txt
        echo
        echo "Payload: ${PAYLOAD}"
        exit 1
      fi

      echo "Sentry was notified of the change!"
  when: on_success
  allow_failure: true
  only:
    - /^v.+$/i
    - master
